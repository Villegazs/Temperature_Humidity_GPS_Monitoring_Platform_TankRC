# FIWARE IoT Platform - Temperature, Humidity & GPS Monitoring
# 
# Unified platform for smart irrigation and GPS tracking with FIWARE components
# Services organized in modular architecture for scalability and maintainability
# 
# Requirements:
#   - Docker Engine 20.10+
#   - Docker Compose v2+
#   - 8GB RAM recommended
# 
# sudo sysctl -w vm.max_map_count=262144
version: "3.8"
services:
  # ============================================================================
  # CUSTOM APPLICATION SERVICES
  # ============================================================================
  
  # Frontend - React Web Interface (Port 80)
  oruga-backend:
    build: ./orion-nexus/oruga-backend
    container_name: oruga-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    depends_on:
      - orion
    volumes:
      - ./oruga-backend:/app
    
  orion-nexus-frontend:
    build:
      context: ./orion-nexus/orion-nexus-frontend
      args:
        VITE_API_URL: http://${PUBLIC_IP:-localhost}:8000
        VITE_ORION_URL: http://${PUBLIC_IP:-localhost}:1026
    container_name: orion-nexus-frontend
    hostname: frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - oruga-backend
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ETL Service - Data Processing & Analytics (Port 8080)
  etl-service:
    build: ./etl-service
    container_name: etl-service
    hostname: etl
    restart: unless-stopped
    expose:
      - "8000"
    ports:
      - "8080:8080"
    depends_on:
      mongo-db:
        condition: service_healthy
      crate-db:
        condition: service_healthy
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s

  # Sensor Gateway - IoT Data Ingestion (Port 81)
  sensor-gateway:
    build: ./sensor-gateway
    container_name: sensor-gateway
    hostname: gateway
    restart: unless-stopped
    expose:
      - "81"
    ports:
      - "81:81"
    depends_on:
      - orion
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/health || exit 1"]
      interval: 1m
      timeout: 5s
      retries: 3
      start_period: 10s
  # Orion es el motor principal, el agente, el context broker
  orion:
    image: fiware/orion-ld
    hostname: orion
    container_name: orion
    depends_on:
      - mongo-db
    networks:
      - default
    expose:
      - "1026"
    ports:
      - "1026:1026" # localhost:1026
    command: -dbhost mongo-db -logLevel DEBUG
    healthcheck:
      test: ["CMD-SHELL", "curl --fail -s http://localhost:1026/version || exit 1"]
      interval: 10m0s
      timeout: 30s
      retries: 5
      start_period: 30s

  #Quantum Leap
  quantumleap:
    image: orchestracities/quantumleap
    hostname: quantumleap
    container_name: fiware-quantumleap
    ports:
      - "8668:8668"
    depends_on:
      - crate-db
      #- redis-db
    environment:
      - CRATE_HOST=crate-db
      - LOGLEVEL=DEBUG


  # Bases de datos
  mongo-db:
    image: mongo:3.6
    hostname: mongo-db
    container_name: db-mongo
    expose:
      - "27017"
    ports:
      - "27017:27017"
    networks:
      - default
    volumes:
      - mongo-db:/data/db
          # AÃ±adimos un healthcheck para que 'etl' espere correctamente
    healthcheck:
      test: ["CMD-SHELL", "mongo --eval 'db.runCommand({ping: 1})'"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s

  crate-db:
    image: crate
    hostname: crate-db
    container_name: db-crate
    ports:
      - "4200:4200"
      - "4300:4300"
      - "5432:5432"
    command: crate -Cauth.host_based.enabled=false  -Ccluster.name=democluster -Chttp.cors.enabled=true -Chttp.cors.allow-origin="*"
    environment:
      - CRATE_HEAP_SIZE=4g
    volumes:
      - crate-db:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4200 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # visualizacion
  grafana:
    image: grafana/grafana
    container_name: grafana
    depends_on:
      - crate-db
    ports:
      - "3000:3000"
    volumes:
      - grafana:/var/lib/grafana

networks:
  default:
    ipam:
      config:
        - subnet: 172.19.1.0/24
volumes:
  mongo-db: ~
  crate-db: ~
  grafana: ~